<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NT Trading OS</title>

  <!-- PWA hooks -->
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="IMG_3561.png" />
  <link rel="icon" href="IMG_3561.png" type="image/png" />
  <meta name="theme-color" content="#16a34a" />

  <style>
    :root {
      --bg: #050810;
      --card: #0b1220;
      --card-soft: #0f172a;
      --primary: #16a34a;
      --primary-soft: rgba(22, 163, 74, 0.15);
      --danger: #ef4444;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border: #1f2937;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #111827 0, #020617 55%);
      color: var(--text-main);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        sans-serif;
      -webkit-font-smoothing: antialiased;
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 14px 16px 10px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(to bottom, #022c22 0, #020617 75%);
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .head-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .brand {
      display: flex;
      flex-direction: column;
    }

    .brand-title {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.03em;
      color: #bbf7d0;
    }

    .brand-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(34, 197, 94, 0.4);
      background: rgba(6, 95, 70, 0.35);
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.9);
    }

    .tab-row {
      margin-top: 10px;
      display: flex;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      padding: 3px;
      border: 1px solid rgba(31, 41, 55, 0.9);
    }

    .tab-btn {
      flex: 1;
      border-radius: 999px;
      border: none;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 500;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
    }

    .tab-btn-active {
      background: rgba(22, 163, 74, 0.2);
      color: #bbf7d0;
    }

    main {
      flex: 1;
      padding: 12px 12px 20px;
      max-width: 600px;
      margin: 0 auto;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    @media (min-width: 540px) {
      .grid-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .card {
      background: linear-gradient(145deg, var(--card) 0, var(--card-soft) 100%);
      border-radius: 14px;
      padding: 10px 11px;
      border: 1px solid rgba(15, 23, 42, 0.9);
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.9);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
    }

    .badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: var(--text-muted);
    }

    .badge-primary {
      border-color: rgba(34, 197, 94, 0.6);
      background: var(--primary-soft);
      color: #bbf7d0;
    }

    .kpi-row {
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .kpi {
      flex: 1;
      min-width: 40%;
    }

    .kpi-label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .kpi-value {
      font-size: 18px;
      font-weight: 700;
      margin-top: 2px;
    }

    .kpi-value.positive {
      color: #22c55e;
    }

    .kpi-value.negative {
      color: #f97373;
    }

    .kpi-sub {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 1px;
    }

    .input-row {
      display: flex;
      gap: 6px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    .input-group {
      flex: 1;
      min-width: 42%;
    }

    label {
      display: block;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    input,
    select {
      width: 100%;
      border-radius: 9px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text-main);
      padding: 6px 8px;
      font-size: 13px;
    }

    input:focus,
    select:focus {
      outline: 1px solid rgba(34, 197, 94, 0.7);
      border-color: rgba(34, 197, 94, 0.7);
    }

    .btn-row {
      display: flex;
      gap: 6px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    button {
      flex: 1;
      border-radius: 999px;
      border: none;
      padding: 7px 10px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
    }

    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #022c22;
    }

    .btn-ghost {
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    .btn-danger {
      background: rgba(248, 113, 113, 0.16);
      color: #fecaca;
      border: 1px solid rgba(239, 68, 68, 0.55);
    }

    .flip-progress {
      margin-top: 6px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
      border: 1px solid #064e3b;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #22c55e, #4ade80, #22c55e);
      transition: width 0.25s ease-out;
    }

    .flip-meta {
      display: flex;
      justify-content: space-between;
      margin-top: 2px;
      font-size: 10px;
      color: var(--text-muted);
    }

    .tiny {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .alert {
      margin-bottom: 10px;
      border-radius: 12px;
      padding: 7px 10px;
      background: rgba(22, 163, 74, 0.15);
      border: 1px solid rgba(34, 197, 94, 0.6);
      font-size: 11px;
      color: #bbf7d0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .alert-strong {
      font-weight: 600;
    }

    .hidden {
      display: none !important;
    }

    .log-list {
      margin-top: 6px;
      max-height: 180px;
      overflow-y: auto;
      border-radius: 9px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(31, 41, 55, 0.9);
    }

    .log-item {
      display: flex;
      justify-content: space-between;
      padding: 6px 8px;
      font-size: 11px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
    }

    .log-item:last-child {
      border-bottom: none;
    }

    .log-main {
      display: flex;
      flex-direction: column;
    }

    .log-tags {
      font-size: 9px;
      color: var(--text-muted);
    }

    .log-profit {
      font-weight: 600;
      min-width: 68px;
      text-align: right;
    }

    .chip {
      display: inline-flex;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 9px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      margin-left: 4px;
    }

    .chip-win {
      border-color: rgba(34, 197, 94, 0.7);
      color: #bbf7d0;
      background: rgba(22, 163, 74, 0.16);
    }

    .chip-loss {
      border-color: rgba(239, 68, 68, 0.7);
      color: #fecaca;
      background: rgba(239, 68, 68, 0.12);
    }

    .tag-list {
      margin-top: 6px;
      border-radius: 9px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(31, 41, 55, 0.9);
      max-height: 190px;
      overflow-y: auto;
    }

    .tag-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 8px;
      font-size: 11px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
    }

    .tag-row:last-child {
      border-bottom: none;
    }

    .tag-label {
      font-weight: 500;
    }

    .tag-meta {
      font-size: 10px;
      color: var(--text-muted);
    }

    footer {
      padding: 6px 12px 12px;
      font-size: 10px;
      color: var(--text-muted);
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="head-row">
        <div class="brand">
          <span class="brand-title">NT Trading OS</span>
          <span class="brand-sub">10-Flip System · Live Edges · Bankroll Extraction</span>
        </div>
        <div class="pill">
          <span class="pill-dot"></span>
          <span>Locked in</span>
        </div>
      </div>

      <div class="tab-row">
        <button class="tab-btn tab-btn-active" id="tabDashboardBtn">Dashboard</button>
        <button class="tab-btn" id="tabJournalBtn">Bet Journal</button>
      </div>
    </header>

    <main>
      <!-- Extraction alert -->
      <div id="alertBar" class="alert hidden">
        <span id="alertText"></span>
        <span class="alert-strong">Extract.</span>
      </div>

      <!-- DASHBOARD VIEW -->
      <div id="dashboardView">
        <!-- BANKROLL / SESSION -->
        <section class="card">
          <div class="card-header">
            <div class="card-title">Bankroll · Session</div>
            <span class="badge-primary badge" id="heatBadge">Neutral</span>
          </div>

          <div class="kpi-row">
            <div class="kpi">
              <div class="kpi-label">Starting Bankroll</div>
              <div class="kpi-value" id="startingBankrollDisplay">$0</div>
              <div class="kpi-sub" id="riskPerBetDisplay">Risk / bet: $0</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">Current Balance (Today)</div>
              <div class="kpi-value" id="currentBalanceDisplay">$0</div>
              <div class="kpi-sub" id="pnlPercentDisplay">P/L: 0% today</div>
            </div>
          </div>

          <div class="input-row">
            <div class="input-group">
              <label for="startingBankrollInput">Starting roll</label>
              <input id="startingBankrollInput" type="number" inputmode="decimal" placeholder="e.g. 2000" />
            </div>
            <div class="input-group">
              <label for="riskPctInput">% risk / bet</label>
              <input id="riskPctInput" type="number" inputmode="decimal" placeholder="e.g. 2.5" />
            </div>
          </div>

          <div class="input-row">
            <div class="input-group">
              <label for="lossLimitInput">Max loss % (day)</label>
              <input id="lossLimitInput" type="number" inputmode="decimal" placeholder="e.g. 15" />
            </div>
            <div class="input-group">
              <label for="sessionTagInput">Session tag</label>
              <input id="sessionTagInput" type="text" placeholder="Thanksgiving board, etc." />
            </div>
          </div>

          <div class="btn-row">
            <button class="btn-primary" id="applyBankrollBtn">Lock in session</button>
            <button class="btn-ghost" id="resetDayBtn">New day</button>
          </div>

          <div class="tiny">
            Rule of thumb: <strong>green = press edges, red = protect roll.</strong> Heat meter responds to your P/L vs loss limit.
          </div>
        </section>

        <!-- 10 FLIP SYSTEM -->
        <section class="card">
          <div class="card-header">
            <div class="card-title">10-Flip System</div>
            <span class="badge" id="flipStatusBadge">Flip 0 / 10</span>
          </div>

          <div class="input-row">
            <div class="input-group">
              <label for="flipTargetInput">Target flips</label>
              <input id="flipTargetInput" type="number" inputmode="numeric" value="10" />
            </div>
            <div class="input-group">
              <label for="flipProfitTargetInput">Profit per flip ($)</label>
              <input id="flipProfitTargetInput" type="number" inputmode="decimal" placeholder="e.g. 200" />
            </div>
          </div>

          <div class="flip-progress">
            <div class="progress-bar">
              <div class="progress-fill" id="flipProgressFill"></div>
            </div>
            <div class="flip-meta">
              <span id="flipMetaLeft">0 completed</span>
              <span id="flipMetaRight">0 / 10 · $0 per flip</span>
            </div>
          </div>

          <div class="btn-row">
            <button class="btn-primary" id="markFlipCompleteBtn">Mark flip complete</button>
            <button class="btn-ghost" id="undoFlipBtn">Undo last flip</button>
          </div>

          <div class="tiny">
            Use flips as <strong>extraction milestones</strong> – each flip is a pre-defined profit target.
            When flips 2, 4, 6, 8, 10 hit, consider <strong>withdrawing a piece of profits.</strong>
          </div>
        </section>

        <!-- LIVE BET INPUT -->
        <section class="card">
          <div class="card-header">
            <div class="card-title">Live Bet Input</div>
            <span class="badge">Cheat sheet</span>
          </div>

          <div class="input-row">
            <div class="input-group">
              <label for="betStakeInput">Stake ($)</label>
              <input id="betStakeInput" type="number" inputmode="decimal" placeholder="50" />
            </div>
            <div class="input-group">
              <label for="betResultInput">Outcome</label>
              <select id="betResultInput">
                <option value="win">Win</option>
                <option value="loss">Loss</option>
                <option value="cashout">Cash out</option>
                <option value="push">Push</option>
              </select>
            </div>
          </div>

          <div class="input-row">
            <div class="input-group">
              <label for="betReturnInput">Returned ($)</label>
              <input id="betReturnInput" type="number" inputmode="decimal" placeholder="Return / cashout" />
            </div>
            <div class="input-group">
              <label for="betTagInput">Tag</label>
              <input id="betTagInput" type="text" placeholder="1H ML, alt spread, etc." />
            </div>
          </div>

          <div class="btn-row">
            <button class="btn-primary" id="addBetBtn">Log bet</button>
            <button class="btn-danger" id="clearBetsBtn">Clear log (today)</button>
          </div>

          <div class="tiny">
            Quick rules: <strong>single / 2-leg > ladders > hail marys.</strong> Cashouts count as realized profit.
          </div>
        </section>

        <!-- STATS & LOG -->
        <section class="card">
          <div class="card-header">
            <div class="card-title">Day Stats & Log</div>
            <span class="badge" id="betsSummaryBadge">0 bets</span>
          </div>

          <div class="kpi-row">
            <div class="kpi">
              <div class="kpi-label">Net P/L (today)</div>
              <div class="kpi-value" id="pnlDisplay">$0.00</div>
              <div class="kpi-sub" id="pnlPerBetDisplay">$0 / bet</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">Volume & hit rate</div>
              <div class="kpi-value" id="hitRateDisplay">0%</div>
              <div class="kpi-sub" id="volumeDisplay">$0 staked</div>
            </div>
          </div>

          <div class="kpi-row">
            <div class="kpi">
              <div class="kpi-label">Return multiple</div>
              <div class="kpi-value" id="returnMultipleDisplay">1.00x</div>
              <div class="kpi-sub">Returned ÷ staked</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">Average stake</div>
              <div class="kpi-value" id="avgStakeDisplay">$0</div>
              <div class="kpi-sub">Per bet</div>
            </div>
          </div>

          <div class="log-list" id="betLog"></div>

          <div class="tiny">
            Use this as your <strong>truth mirror.</strong> Volume, hit rate, avg stake, and
            extraction tell you when to <strong>press</strong> vs <strong>shut it down.</strong>
          </div>
        </section>
      </div>

      <!-- JOURNAL VIEW -->
      <div id="journalView" class="hidden">
        <section class="card">
          <div class="card-header">
            <div class="card-title">Bet Journal · Today</div>
            <span class="badge" id="journalCountBadge">0 logged</span>
          </div>

          <div class="kpi-row">
            <div class="kpi">
              <div class="kpi-label">Wins</div>
              <div class="kpi-value positive" id="journalWinsDisplay">0</div>
              <div class="kpi-sub" id="journalWinsProfitDisplay">$0 profit</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">Losses</div>
              <div class="kpi-value negative" id="journalLossesDisplay">0</div>
              <div class="kpi-sub" id="journalLossesProfitDisplay">$0 given back</div>
            </div>
          </div>

          <div class="kpi-row">
            <div class="kpi">
              <div class="kpi-label">Cashouts</div>
              <div class="kpi-value" id="journalCashoutDisplay">0</div>
              <div class="kpi-sub" id="journalCashoutProfitDisplay">$0 net</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">Push / neutral</div>
              <div class="kpi-value" id="journalPushDisplay">0</div>
              <div class="kpi-sub" id="journalPushProfitDisplay">$0 impact</div>
            </div>
          </div>

          <div class="tiny" id="journalInsightText">
            Log a few bets and this will start reflecting your strongest & weakest zones.
          </div>

          <div class="tiny" style="margin-top:8px;">
            Top tags by volume & profit:
          </div>
          <div class="tag-list" id="tagStats"></div>
        </section>
      </div>
    </main>

    <footer>
      NT Trading OS · Saved locally on this device. Clear log to start a fresh day.
    </footer>
  </div>

  <script>
    const STORAGE_KEY = "ntTradingState_v1";

    const defaultState = {
      startingBankroll: 0,
      riskPct: 0,
      lossLimitPct: 0,
      sessionTag: "",
      flipsCompleted: 0,
      flipTarget: 10,
      flipProfitTarget: 0,
      bets: [] // {id, stake, result, returned, profit, tag, ts}
    };

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return { ...defaultState };
        const parsed = JSON.parse(raw);
        return { ...defaultState, ...parsed };
      } catch (e) {
        return { ...defaultState };
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    // State
    let state = loadState();

    // DOM references
    const startingBankrollDisplay = document.getElementById("startingBankrollDisplay");
    const riskPerBetDisplay = document.getElementById("riskPerBetDisplay");
    const currentBalanceDisplay = document.getElementById("currentBalanceDisplay");
    const pnlPercentDisplay = document.getElementById("pnlPercentDisplay");
    const heatBadge = document.getElementById("heatBadge");

    const startingBankrollInput = document.getElementById("startingBankrollInput");
    const riskPctInput = document.getElementById("riskPctInput");
    const lossLimitInput = document.getElementById("lossLimitInput");
    const sessionTagInput = document.getElementById("sessionTagInput");

    const flipTargetInput = document.getElementById("flipTargetInput");
    const flipProfitTargetInput = document.getElementById("flipProfitTargetInput");
    const flipStatusBadge = document.getElementById("flipStatusBadge");
    const flipProgressFill = document.getElementById("flipProgressFill");
    const flipMetaLeft = document.getElementById("flipMetaLeft");
    const flipMetaRight = document.getElementById("flipMetaRight");

    const betStakeInput = document.getElementById("betStakeInput");
    const betResultInput = document.getElementById("betResultInput");
    const betReturnInput = document.getElementById("betReturnInput");
    const betTagInput = document.getElementById("betTagInput");

    const pnlDisplay = document.getElementById("pnlDisplay");
    const pnlPerBetDisplay = document.getElementById("pnlPerBetDisplay");
    const hitRateDisplay = document.getElementById("hitRateDisplay");
    const volumeDisplay = document.getElementById("volumeDisplay");
    const returnMultipleDisplay = document.getElementById("returnMultipleDisplay");
    const avgStakeDisplay = document.getElementById("avgStakeDisplay");
    const betsSummaryBadge = document.getElementById("betsSummaryBadge");
    const betLog = document.getElementById("betLog");

    // Journal DOM
    const journalCountBadge = document.getElementById("journalCountBadge");
    const journalWinsDisplay = document.getElementById("journalWinsDisplay");
    const journalLossesDisplay = document.getElementById("journalLossesDisplay");
    const journalCashoutDisplay = document.getElementById("journalCashoutDisplay");
    const journalPushDisplay = document.getElementById("journalPushDisplay");
    const journalWinsProfitDisplay = document.getElementById("journalWinsProfitDisplay");
    const journalLossesProfitDisplay = document.getElementById("journalLossesProfitDisplay");
    const journalCashoutProfitDisplay = document.getElementById("journalCashoutProfitDisplay");
    const journalPushProfitDisplay = document.getElementById("journalPushProfitDisplay");
    const journalInsightText = document.getElementById("journalInsightText");
    const tagStats = document.getElementById("tagStats");

    // Tabs
    const tabDashboardBtn = document.getElementById("tabDashboardBtn");
    const tabJournalBtn = document.getElementById("tabJournalBtn");
    const dashboardView = document.getElementById("dashboardView");
    const journalView = document.getElementById("journalView");

    // Buttons
    const applyBankrollBtn = document.getElementById("applyBankrollBtn");
    const resetDayBtn = document.getElementById("resetDayBtn");
    const markFlipCompleteBtn = document.getElementById("markFlipCompleteBtn");
    const undoFlipBtn = document.getElementById("undoFlipBtn");
    const addBetBtn = document.getElementById("addBetBtn");
    const clearBetsBtn = document.getElementById("clearBetsBtn");

    // Alert
    const alertBar = document.getElementById("alertBar");
    const alertText = document.getElementById("alertText");

    function formatMoney(v) {
      const num = Number(v) || 0;
      const sign = num < 0 ? "-" : "";
      return sign + "$" + Math.abs(num).toFixed(2);
    }

    function computeStats() {
      const bets = state.bets;
      let staked = 0;
      let returned = 0;
      let wins = 0;
      bets.forEach((b) => {
        staked += b.stake;
        returned += b.returned;
        if (b.profit > 0) wins++;
      });
      const pnl = returned - staked;
      const pnlPct = state.startingBankroll
        ? (pnl / state.startingBankroll) * 100
        : 0;
      const hitRate = bets.length ? (wins / bets.length) * 100 : 0;
      const pnlPerBet = bets.length ? pnl / bets.length : 0;
      const avgStake = bets.length ? staked / bets.length : 0;
      const returnMultiple = staked > 0 ? returned / staked : 1;

      return { staked, returned, pnl, pnlPct, hitRate, pnlPerBet, avgStake, returnMultiple };
    }

    function computeJournal() {
      const bets = state.bets;
      let wins = 0,
        losses = 0,
        cashouts = 0,
        pushes = 0;
      let winProfit = 0,
        lossProfit = 0,
        cashoutProfit = 0,
        pushProfit = 0;

      const tagMap = {}; // tag -> {count, staked, profit}

      bets.forEach((b) => {
        if (b.result === "win") {
          wins++;
          winProfit += b.profit;
        } else if (b.result === "loss") {
          losses++;
          lossProfit += b.profit;
        } else if (b.result === "cashout") {
          cashouts++;
          cashoutProfit += b.profit;
        } else if (b.result === "push") {
          pushes++;
          pushProfit += b.profit;
        }

        const tag = b.tag && b.tag.trim() ? b.tag.trim() : "untagged";
        if (!tagMap[tag]) {
          tagMap[tag] = { count: 0, staked: 0, profit: 0 };
        }
        tagMap[tag].count += 1;
        tagMap[tag].staked += b.stake;
        tagMap[tag].profit += b.profit;
      });

      const tagArray = Object.keys(tagMap).map((tag) => ({
        tag,
        ...tagMap[tag],
      }));

      tagArray.sort((a, b) => b.staked - a.staked); // top volume

      return {
        wins,
        losses,
        cashouts,
        pushes,
        winProfit,
        lossProfit,
        cashoutProfit,
        pushProfit,
        tagArray,
      };
    }

    function updateHeatMeter(pnlPct) {
      const limit = state.lossLimitPct || 0;
      if (!limit) {
        heatBadge.textContent = "Neutral";
        heatBadge.className = "badge-primary badge";
        return;
      }

      if (pnlPct >= 5) {
        heatBadge.textContent = "Cooking · Press edges";
        heatBadge.className = "badge-primary badge";
      } else if (pnlPct <= -limit * 0.75) {
        heatBadge.textContent = "Danger · Shut it down";
        heatBadge.className = "badge-primary badge";
      } else if (pnlPct <= -limit * 0.4) {
        heatBadge.textContent = "Red zone · Only A+ edges";
        heatBadge.className = "badge-primary badge";
      } else {
        heatBadge.textContent = "Neutral";
        heatBadge.className = "badge-primary badge";
      }
    }

    function updateExtractionAlert() {
      const target = state.flipTarget || 10;
      const completed = state.flipsCompleted || 0;
      const flipProfit = state.flipProfitTarget || 0;

      const milestones = [2, 4, 6, 8, 10];
      if (milestones.includes(completed) && flipProfit > 0) {
        const totalTarget = completed * flipProfit;
        alertText.textContent =
          "Flip " +
          completed +
          " of " +
          target +
          " hit · consider skimming around " +
          formatMoney(totalTarget) +
          " in profits.";
        alertBar.classList.remove("hidden");
      } else {
        alertBar.classList.add("hidden");
      }
    }

    function renderJournal() {
      const {
        wins,
        losses,
        cashouts,
        pushes,
        winProfit,
        lossProfit,
        cashoutProfit,
        pushProfit,
        tagArray,
      } = computeJournal();

      const totalBets = state.bets.length || 0;
      journalCountBadge.textContent = totalBets + " logged";

      journalWinsDisplay.textContent = wins;
      journalLossesDisplay.textContent = losses;
      journalCashoutDisplay.textContent = cashouts;
      journalPushDisplay.textContent = pushes;

      journalWinsProfitDisplay.textContent = formatMoney(winProfit) + " net";
      journalLossesProfitDisplay.textContent = formatMoney(lossProfit) + " net";
      journalCashoutProfitDisplay.textContent = formatMoney(cashoutProfit) + " net";
      journalPushProfitDisplay.textContent = formatMoney(pushProfit) + " net";

      // Insight text
      if (!totalBets) {
        journalInsightText.textContent =
          "Log a few bets and this will start reflecting your strongest & weakest zones.";
      } else {
        let strongest = "N/A";
        let weakest = "N/A";
        if (tagArray.length) {
          const sortedByProfit = tagArray.slice().sort((a, b) => b.profit - a.profit);
          strongest = sortedByProfit[0];
          weakest = sortedByProfit[sortedByProfit.length - 1];
        }

        const strongestText =
          strongest && strongest.tag
            ? `Strongest so far: ${strongest.tag} (${formatMoney(
                strongest.profit
              )} net).`
            : "";
        const weakestText =
          weakest && weakest.tag
            ? `Leak to watch: ${weakest.tag} (${formatMoney(
                weakest.profit
              )} net).`
            : "";

        journalInsightText.textContent =
          strongestText || weakestText
            ? strongestText + " " + weakestText
            : "Keep logging volume — patterns will show quickly.";
      }

      // Tag stats list
      tagStats.innerHTML = "";
      if (!tagArray.length) {
        const empty = document.createElement("div");
        empty.style.padding = "8px 10px";
        empty.style.fontSize = "11px";
        empty.style.color = "#6b7280";
        empty.textContent = "No tags yet. Use the TAG field when you log bets.";
        tagStats.appendChild(empty);
      } else {
        tagArray.slice(0, 8).forEach((t) => {
          const row = document.createElement("div");
          row.className = "tag-row";

          const left = document.createElement("div");
          left.className = "tag-label";
          left.textContent = t.tag;

          const right = document.createElement("div");
          right.style.textAlign = "right";

          const meta1 = document.createElement("div");
          meta1.className = "tag-meta";
          meta1.textContent =
            t.count + " bets · " + formatMoney(t.staked) + " staked";

          const meta2 = document.createElement("div");
          meta2.className = "tag-meta";
          meta2.textContent = "Net: " + formatMoney(t.profit);

          right.appendChild(meta1);
          right.appendChild(meta2);

          row.appendChild(left);
          row.appendChild(right);
          tagStats.appendChild(row);
        });
      }
    }

    function render() {
      // Stats
      const {
        staked,
        returned,
        pnl,
        pnlPct,
        hitRate,
        pnlPerBet,
        avgStake,
        returnMultiple,
      } = computeStats();
      const currentBalance = (state.startingBankroll || 0) + pnl;
      const riskPerBet =
        state.startingBankroll && state.riskPct
          ? (state.startingBankroll * state.riskPct) / 100
          : 0;

      startingBankrollDisplay.textContent = formatMoney(state.startingBankroll);
      riskPerBetDisplay.textContent =
        "Risk / bet: " +
        formatMoney(riskPerBet) +
        (state.riskPct ? ` (${state.riskPct}% of roll)` : "");

      currentBalanceDisplay.textContent = formatMoney(currentBalance);
      pnlDisplay.textContent = formatMoney(pnl);
      pnlDisplay.className =
        "kpi-value " + (pnl > 0 ? "positive" : pnl < 0 ? "negative" : "");
      pnlPercentDisplay.textContent =
        "P/L: " + pnlPct.toFixed(2) + "% today";

      pnlPerBetDisplay.textContent =
        formatMoney(pnlPerBet) + " / bet · " + (state.bets.length || 0) + " bets";
      hitRateDisplay.textContent = hitRate.toFixed(1) + "% hit rate";
      volumeDisplay.textContent =
        formatMoney(staked) + " staked · " + formatMoney(returned) + " returned";

      returnMultipleDisplay.textContent = returnMultiple.toFixed(2) + "x";
      avgStakeDisplay.textContent = formatMoney(avgStake);

      betsSummaryBadge.textContent =
        (state.bets.length || 0) + " bets · " + (state.sessionTag || "no tag");

      updateHeatMeter(pnlPct);
      updateExtractionAlert();

      // flips
      const target = state.flipTarget || 10;
      const completed = state.flipsCompleted || 0;
      const profitTarget = state.flipProfitTarget || 0;
      flipStatusBadge.textContent = `Flip ${completed} / ${target}`;
      const pct = Math.max(0, Math.min(100, (completed / target) * 100));
      flipProgressFill.style.width = pct + "%";
      flipMetaLeft.textContent = `${completed} completed`;
      flipMetaRight.textContent = `${completed} / ${target} · $${profitTarget.toFixed(
        0
      )} per flip`;

      // inputs reflect state
      if (state.startingBankroll) startingBankrollInput.value = state.startingBankroll;
      if (state.riskPct) riskPctInput.value = state.riskPct;
      if (state.lossLimitPct) lossLimitInput.value = state.lossLimitPct;
      if (state.sessionTag) sessionTagInput.value = state.sessionTag;
      if (state.flipTarget) flipTargetInput.value = state.flipTarget;
      if (state.flipProfitTarget)
        flipProfitTargetInput.value = state.flipProfitTarget;

      // log
      betLog.innerHTML = "";
      if (!state.bets.length) {
        const empty = document.createElement("div");
        empty.style.padding = "8px 10px";
        empty.style.fontSize = "11px";
        empty.style.color = "#6b7280";
        empty.textContent = "No bets logged yet. Track every decision.";
        betLog.appendChild(empty);
      } else {
        state.bets
          .slice()
          .reverse()
          .forEach((b) => {
            const row = document.createElement("div");
            row.className = "log-item";

            const main = document.createElement("div");
            main.className = "log-main";

            const title = document.createElement("div");
            title.textContent = `${formatMoney(b.stake)} → ${formatMoney(
              b.returned
            )}`;

            const tags = document.createElement("div");
            tags.className = "log-tags";
            const when = new Date(b.ts).toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit",
            });
            tags.textContent = `${when} · ${b.result.toUpperCase()} · ${
              b.tag || "untagged"
            }`;

            main.appendChild(title);
            main.appendChild(tags);

            const profit = document.createElement("div");
            profit.className =
              "log-profit " + (b.profit > 0 ? "positive" : b.profit < 0 ? "negative" : "");
            profit.textContent = formatMoney(b.profit);

            const chip = document.createElement("span");
            chip.className =
              "chip " +
              (b.profit > 0 ? "chip-win" : b.profit < 0 ? "chip-loss" : "");
            chip.textContent =
              b.result === "cashout"
                ? "Cash out"
                : b.result.charAt(0).toUpperCase() + b.result.slice(1);
            profit.appendChild(chip);

            row.appendChild(main);
            row.appendChild(profit);
            betLog.appendChild(row);
          });
      }

      // Journal
      renderJournal();
    }

    // Handlers
    applyBankrollBtn.addEventListener("click", () => {
      const start = Number(startingBankrollInput.value) || 0;
      const riskPct = Number(riskPctInput.value) || 0;
      const lossLimit = Number(lossLimitInput.value) || 0;
      const tag = sessionTagInput.value || "";

      state.startingBankroll = start;
      state.riskPct = riskPct;
      state.lossLimitPct = lossLimit;
      state.sessionTag = tag;

      saveState();
      render();
    });

    resetDayBtn.addEventListener("click", () => {
      state = {
        ...defaultState,
        startingBankroll: state.startingBankroll, // keep base roll
        riskPct: state.riskPct,
        lossLimitPct: state.lossLimitPct,
      };
      saveState();
      render();
    });

    markFlipCompleteBtn.addEventListener("click", () => {
      const target = Number(flipTargetInput.value) || 10;
      const profitTarget = Number(flipProfitTargetInput.value) || 0;
      state.flipTarget = target;
      state.flipProfitTarget = profitTarget;
      state.flipsCompleted = (state.flipsCompleted || 0) + 1;
      if (state.flipsCompleted > state.flipTarget) {
        state.flipsCompleted = state.flipTarget;
      }
      saveState();
      render();
    });

    undoFlipBtn.addEventListener("click", () => {
      state.flipsCompleted = Math.max(0, (state.flipsCompleted || 0) - 1);
      saveState();
      render();
    });

    addBetBtn.addEventListener("click", () => {
      const stake = Number(betStakeInput.value);
      const result = betResultInput.value;
      const returned = Number(betReturnInput.value || 0);
      const tag = betTagInput.value || "";

      if (!stake || stake <= 0) {
        alert("Enter stake.");
        return;
      }

      let profit = 0;
      if (result === "win" || result === "cashout" || result === "push") {
        profit = returned - stake;
      } else if (result === "loss") {
        profit = -stake;
      }

      const bet = {
        id: Date.now(),
        stake,
        result,
        returned,
        profit,
        tag,
        ts: Date.now(),
      };
      state.bets.push(bet);

      betStakeInput.value = "";
      betReturnInput.value = "";
      betTagInput.value = "";

      saveState();
      render();
    });

    clearBetsBtn.addEventListener("click", () => {
      if (!confirm("Clear today's bet log?")) return;
      state.bets = [];
      saveState();
      render();
    });

    // Tabs
    tabDashboardBtn.addEventListener("click", () => {
      tabDashboardBtn.classList.add("tab-btn-active");
      tabJournalBtn.classList.remove("tab-btn-active");
      dashboardView.classList.remove("hidden");
      journalView.classList.add("hidden");
    });

    tabJournalBtn.addEventListener("click", () => {
      tabJournalBtn.classList.add("tab-btn-active");
      tabDashboardBtn.classList.remove("tab-btn-active");
      dashboardView.classList.add("hidden");
      journalView.classList.remove("hidden");
    });

    // Init
    render();

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js").catch(() => {});
    }
  </script>
</body>
</html>
