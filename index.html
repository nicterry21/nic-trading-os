<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>A-T Trading Console ‚Äì Phase 2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#050810" />
  <link rel="manifest" href="manifest.json" />

  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background:
        radial-gradient(circle at top left, #0f172a 0, transparent 55%),
        radial-gradient(circle at bottom right, #022c22 0, transparent 55%),
        #020617;
      color: #f9fafb;
    }

    .app {
      max-width: 1100px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    .app-header {
      text-align: left;
      margin-bottom: 0.75rem;
    }

    .app-header h1 {
      margin: 0;
      font-size: 1.9rem;
    }

    .app-header p {
      margin: 0.3rem 0 0;
      color: #9ca3af;
    }

    /* Top nav (pages) */
    .top-nav {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid #111827;
      padding-bottom: 0.25rem;
      position: sticky;
      top: 0;
      z-index: 40;
      background: linear-gradient(180deg, #020617 0%, #050810 100%);
      padding-top: 0.25rem;
    }

    .nav-tab {
      border: none;
      background: transparent;
      color: #9ca3af;
      padding: 0.4rem 0.8rem;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .nav-tab.active {
      background: #16a34a;
      color: #fff;
    }

    .nav-tab:hover {
      background: #111827;
    }

    /* Cards */

    .card {
      background: rgba(15, 23, 42, 0.92);
      border-radius: 18px;
      padding: 1.15rem 1.25rem;
      margin-bottom: 1.1rem;
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow:
        0 18px 40px rgba(0, 0, 0, 0.7),
        0 0 0 1px rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(10px);
    }

    .card h2 {
      margin-top: 0;
      margin-bottom: 0.75rem;
      font-size: 1.2rem;
    }

    .card-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .subtext {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 0;
      margin-bottom: 0.5rem;
    }

    .subtext.muted {
      opacity: 0.7;
    }

    /* Views */
    .view {
      display: none;
    }

    .view.active {
      display: block;
    }

    /* Dashboard */

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .dash-item {
      background: #020617;
      border-radius: 12px;
      padding: 0.6rem 0.75rem;
      border: 1px solid #111827;
    }

    .dash-item label,
    .dash-item .label {
      display: block;
      font-size: 0.7rem;
      text-transform: uppercase;
      color: #9ca3af;
      letter-spacing: 0.06em;
      margin-bottom: 0.2rem;
    }

    .dash-item input {
      width: 100%;
      padding: 0.35rem 0.45rem;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
    }

    .dash-item .value {
      font-size: 1rem;
      font-weight: 600;
    }

    .dash-item .heat {
      font-size: 1.2rem;
    }

    .dashboard-actions {
      margin-top: 0.4rem;
    }

    /* Buttons */

    .btn {
      border: none;
      border-radius: 999px;
      padding: 0.45rem 0.9rem;
      margin-right: 0.35rem;
      cursor: pointer;
      font-size: 0.85rem;
      background: #111827;
      color: #e5e7eb;
      transition: background 0.18s, transform 0.1s;
    }

    .btn-primary {
      background: #16a34a;
      color: #fff;
    }

    .btn-secondary {
      background: #374151;
    }

    .btn-danger {
      background: #b91c1c;
    }

    .btn-sm {
      padding: 0.25rem 0.6rem;
      font-size: 0.75rem;
    }

    .btn:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
    }

    .btn:active {
      transform: translateY(0);
      filter: brightness(0.95);
    }

    /* Audio */

    .audio-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8rem;
    }

    .audio-controls label {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    /* Form */

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 0.75rem;
    }

    .form-item label {
      display: block;
      font-size: 0.75rem;
      margin-bottom: 0.25rem;
      color: #9ca3af;
    }

    .form-item input,
    .form-item select {
      width: 100%;
      padding: 0.4rem 0.5rem;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
    }

    .form-actions {
      margin-top: 0.9rem;
    }

    /* Playbook & Combos */

    .playbook-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1rem;
    }

    .playbook-block {
      background: #020617;
      border-radius: 12px;
      padding: 0.75rem 0.9rem;
      border: 1px solid #111827;
    }

    .list {
      margin: 0.3rem 0 0;
      padding-left: 1.2rem;
      font-size: 0.8rem;
    }

    .list li {
      margin-bottom: 0.25rem;
    }

    /* Alerts */

    .alert-list {
      list-style: none;
      padding-left: 0;
      margin: 0.25rem 0 0;
      font-size: 0.8rem;
    }

    .alert-list li {
      padding: 0.35rem 0.5rem;
      margin-bottom: 0.25rem;
      border-radius: 8px;
      background: #020617;
      border: 1px solid #111827;
    }

    /* Table */

    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    th,
    td {
      padding: 0.5rem 0.4rem;
      text-align: left;
    }

    thead {
      background: #020617;
    }

    tbody tr:nth-child(even) {
      background: #030712;
    }

    tbody tr:nth-child(odd) {
      background: #020617;
    }

    .status-pill {
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      text-transform: uppercase;
    }

    .status-active {
      background: rgba(34, 197, 94, 0.15);
      color: #4ade80;
    }

    .status-void {
      background: rgba(248, 113, 113, 0.15);
      color: #fb7185;
    }

    .result-win {
      color: #4ade80;
    }

    .result-loss {
      color: #f97373;
    }

    .result-push {
      color: #e5e7eb;
    }

    .result-pending {
      color: #facc15;
    }

    /* Heat colors */

    .heat-low {
      color: #22c55e;
    }

    .heat-medium {
      color: #facc15;
    }

    .heat-high {
      color: #fb7185;
    }

    /* Scroll cards to avoid endless page scroll */
    .scroll-card {
      max-height: 65vh;
      overflow-y: auto;
    }

    .scroll-card h2,
    .scroll-card .bets-log-controls {
      position: sticky;
      top: 0;
      background: inherit;
      z-index: 5;
    }

    /* 10 Flip */
    .flip-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .flip-item {
      background: #020617;
      border-radius: 12px;
      padding: 0.6rem 0.75rem;
      border: 1px solid #111827;
    }

    .flip-item label {
      display: block;
      font-size: 0.75rem;
      color: #9ca3af;
      margin-bottom: 0.25rem;
    }

    .flip-item input {
      width: 100%;
      padding: 0.35rem 0.45rem;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
    }

    .flip-meta {
      font-size: 0.8rem;
      margin-bottom: 0.5rem;
      color: #e5e7eb;
    }

    .flip-meta span {
      display: block;
      margin-bottom: 0.15rem;
    }

    .bets-log-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
      flex-wrap: wrap;
    }

    .bets-log-controls select {
      padding: 0.3rem 0.5rem;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.8rem;
    }

    .bets-log-buttons {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
    }

    /* Mobile tweaks */
    @media (max-width: 768px) {
      .app {
        padding: 0.75rem;
      }

      .app-header h1 {
        font-size: 1.4rem;
      }

      .card {
        padding: 0.9rem 0.9rem;
        border-radius: 16px;
      }

      .dashboard-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.5rem;
      }

      .dash-item {
        padding: 0.5rem 0.55rem;
      }

      .bets-log-controls {
        flex-direction: column;
        align-items: flex-start;
      }

      table th,
      table td {
        padding: 0.35rem 0.3rem;
        font-size: 0.75rem;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <h1>A-T Trading Console</h1>
      <p>Real-time bankroll, heat, traps, and controlled outputs.</p>
    </header>

    <!-- Top Nav / Pages -->
    <nav class="top-nav">
      <button class="nav-tab active" data-target="console">Console</button>
      <button class="nav-tab" data-target="flip">10 Flip Challenge</button>
    </nav>

    <!-- VIEW: CONSOLE -->
    <div class="view active" data-view="console">
      <!-- DASHBOARD -->
      <section class="card">
        <div class="card-header-row">
          <h2>üìä Dashboard</h2>
          <div class="audio-controls">
            <label>
              <input type="checkbox" id="audioToggle" />
              Audio Coach
            </label>
            <button id="speakRecapBtn" class="btn btn-secondary btn-sm">
              Speak Session Recap
            </button>
          </div>
        </div>

        <div class="dashboard-grid">
          <div class="dash-item">
            <label>Current Bankroll</label>
            <input type="number" id="currentBankroll" />
          </div>
          <div class="dash-item">
            <label>Starting Bankroll (Session)</label>
            <input type="number" id="sessionBankroll" />
          </div>
          <div class="dash-item">
            <span class="label">Daily P/L</span>
            <span id="dailyPL" class="value"></span>
          </div>
          <div class="dash-item">
            <span class="label">Total P/L</span>
            <span id="totalPL" class="value"></span>
          </div>
          <div class="dash-item">
            <span class="label">Win Rate (All-Time)</span>
            <span id="winRate" class="value"></span>
          </div>
          <div class="dash-item">
            <span class="label">Bets Today</span>
            <span id="betsToday" class="value"></span>
          </div>
          <div class="dash-item">
            <span class="label">Heat Level</span>
            <span id="heatLevel" class="value heat"></span>
          </div>
          <div class="dash-item">
            <span class="label">Session ID</span>
            <span id="sessionId" class="value"></span>
          </div>
          <div class="dash-item">
            <span class="label">Session P/L</span>
            <span id="sessionPL" class="value"></span>
          </div>
          <div class="dash-item">
            <span class="label">Session Bets</span>
            <span id="sessionBets" class="value"></span>
          </div>
        </div>

        <div class="dashboard-actions">
          <button id="startSessionBtn" class="btn btn-primary">Start New Session</button>
          <button id="saveBankrollBtn" class="btn">Save Bankroll</button>
        </div>
      </section>

      <!-- PLAYBOOK & COMBOS -->
      <section class="card">
        <h2>üéØ Controlled Outputs (Phase 2)</h2>
        <div class="playbook-grid">
          <div class="playbook-block">
            <h3>3-Bet Controlled Playbook</h3>
            <p class="subtext">Top 3 pending plays ranked by edge & discipline.</p>
            <ol id="playbook3List" class="list"></ol>
          </div>
          <div class="playbook-block">
            <h3>2-Leg Combos</h3>
            <p class="subtext">Best 2-leg combinations from your pending pool.</p>
            <ol id="combosList" class="list"></ol>
          </div>
        </div>
      </section>

      <!-- TRAPS & ALERTS -->
      <section class="card">
        <h2>‚ö†Ô∏è Traps & Alerts</h2>
        <p class="subtext">Live scan of your behavior today.</p>
        <ul id="trapList" class="alert-list"></ul>
        <p id="noTrapsMsg" class="subtext muted"></p>
      </section>

      <!-- BET ENTRY FORM -->
      <section class="card">
        <h2 id="formTitle">Log Bet</h2>
        <form id="betForm">
          <div class="form-grid">
            <div class="form-item">
              <label>Date</label>
              <input type="date" id="betDate" required />
            </div>
            <div class="form-item">
              <label>Time</label>
              <input type="time" id="betTime" required />
            </div>
            <div class="form-item">
              <label>Sport</label>
              <input type="text" id="betSport" placeholder="NBA, NFL..." />
            </div>
            <div class="form-item">
              <label>Market</label>
              <input type="text" id="betMarket" placeholder="Spread, Total, PRA..." />
            </div>
            <div class="form-item">
              <label>Description</label>
              <input type="text" id="betDescription" placeholder="Lakers -3.5, Tatum o27.5..." />
            </div>
            <div class="form-item">
              <label>Odds (American)</label>
              <input type="number" id="betOdds" required />
            </div>
            <div class="form-item">
              <label>Stake</label>
              <input type="number" id="betStake" required />
            </div>
            <div class="form-item">
              <label>Result</label>
              <select id="betResult">
                <option value="Pending">Pending</option>
                <option value="Win">Win</option>
                <option value="Loss">Loss</option>
                <option value="Push">Push</option>
              </select>
            </div>
            <div class="form-item">
              <label>Risk Tag</label>
              <select id="betRiskTag">
                <option value="Safe">Safe</option>
                <option value="Standard" selected>Standard</option>
                <option value="Aggressive">Aggressive</option>
              </select>
            </div>
            <div class="form-item">
              <label>Confidence (1-5)</label>
              <input type="number" id="betConfidence" min="1" max="5" value="3" />
            </div>
            <div class="form-item">
              <label>Emotion Tag</label>
              <input type="text" id="betEmotion" placeholder="Calm, Tilted, Locked-in..." />
            </div>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="submitBetBtn">Save Bet</button>
            <button type="button" class="btn btn-secondary" id="cancelEditBtn" style="display:none;">Cancel Edit</button>
          </div>
        </form>
      </section>

      <!-- BET TABLE -->
      <section class="card scroll-card">
        <h2>Bets Log</h2>

        <div class="bets-log-controls">
          <div>
            <span class="subtext">Filter:</span>
            <select id="logFilterSelect">
              <option value="all">All Bets</option>
              <option value="today">Today Only</option>
              <option value="pending">Pending Only</option>
            </select>
          </div>
          <div class="bets-log-buttons">
            <button id="exportBetsBtn" class="btn btn-secondary btn-sm">Export Bets (CSV)</button>
            <button id="resetBetsBtn" class="btn btn-danger btn-sm">Reset Bets</button>
          </div>
        </div>

        <div class="table-wrapper">
          <table id="betsTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Date</th>
                <th>Time</th>
                <th>Sport</th>
                <th>Market</th>
                <th>Description</th>
                <th>Odds</th>
                <th>Stake</th>
                <th>Result</th>
                <th>Risk</th>
                <th>Net</th>
                <th>Status</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- VIEW: 10 FLIP MODULE -->
    <div class="view" data-view="flip">
      <section class="card">
        <h2>üîÅ 10 Flip Challenge</h2>
        <p class="subtext">
          Set your starting bankroll and target multiplier (e.g., 2x), then log each flip's result.
          The module tracks up to 10 flips and saves in your browser.
        </p>

        <div class="flip-grid">
          <div class="flip-item">
            <label>Starting Bankroll</label>
            <input type="number" id="flipStartBankroll" />
          </div>
          <div class="flip-item">
            <label>Target Multiplier per Flip</label>
            <input type="number" id="flipMultiplier" step="0.1" value="2" />
          </div>
          <div class="flip-item">
            <label>Total Flips</label>
            <input type="number" id="flipTotal" value="10" />
          </div>
        </div>

        <button id="initFlipBtn" class="btn btn-primary">Initialize / Reset Challenge</button>

        <div class="card" style="margin-top: 1rem; background:#020617;">
          <h3 style="margin-top:0;">Current Flip</h3>
          <div class="flip-meta" id="flipMeta">
            <!-- populated by JS -->
          </div>
          <div class="flip-item">
            <label>Result After This Flip (Bankroll)</label>
            <input type="number" id="flipResultInput" />
          </div>
          <button id="saveFlipResultBtn" class="btn btn-secondary" style="margin-top:0.5rem;">
            Save Flip Outcome
          </button>
        </div>
      </section>

      <section class="card scroll-card">
        <h2>Flip History</h2>
        <p class="subtext">Track each flip's start, target, result, and status.</p>

        <div class="bets-log-controls">
          <span class="subtext">History Controls:</span>
          <div class="bets-log-buttons">
            <button id="exportFlipBtn" class="btn btn-secondary btn-sm">Export Flips (CSV)</button>
            <button id="resetFlipBtn" class="btn btn-danger btn-sm">Reset Flip History</button>
          </div>
        </div>

        <div class="table-wrapper">
          <table id="flipTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Start</th>
                <th>Target</th>
                <th>Result</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ====== GLOBAL STATE ======
    let bets = [];
    let settings = {
      bankroll: 0,
      sessionBankroll: 0,
      sessionId: "",
      audioEnabled: false
    };

    let flipState = {
      startingBankroll: 0,
      multiplier: 2,
      totalFlips: 10,
      currentFlip: 1,
      history: [] // {flip, start, target, result, status}
    };

    let editingBetId = null;
    let lastHeatLevel = 0;
    let lastTrapKeys = [];

    // ====== STORAGE ======
    function loadState() {
      const storedBets = localStorage.getItem("at_bets");
      const storedSettings = localStorage.getItem("at_settings");
      const storedFlip = localStorage.getItem("at_flip");
      if (storedBets) bets = JSON.parse(storedBets);
      if (storedSettings) settings = JSON.parse(storedSettings);
      if (storedFlip) flipState = JSON.parse(storedFlip);
    }

    function saveState() {
      localStorage.setItem("at_bets", JSON.stringify(bets));
      localStorage.setItem("at_settings", JSON.stringify(settings));
      localStorage.setItem("at_flip", JSON.stringify(flipState));
    }

    // ====== HELPERS ======
    function generateBetId() {
      return bets.length ? Math.max(...bets.map(b => b.id)) + 1 : 1;
    }

    function todayString() {
      const d = new Date();
      return d.toISOString().split("T")[0];
    }

    function calculateNet(result, stake, odds, status) {
      if (status !== "Active") return 0;
      if (!result || result === "Pending") return 0;
      stake = Number(stake || 0);
      odds = Number(odds || 0);
      if (!stake || !odds) return 0;

      if (result === "Push") return 0;
      if (result === "Loss") return -stake;
      if (result === "Win") {
        if (odds > 0) return (stake * odds) / 100;
        return (stake * 100) / Math.abs(odds);
      }
      return 0;
    }

    function parseHourFromTimeString(timeStr) {
      if (!timeStr) return null;
      const parts = timeStr.split(":");
      if (parts.length < 2) return null;
      const hh = parseInt(parts[0], 10);
      const mm = parseInt(parts[1], 10);
      if (isNaN(hh)) return null;
      return hh + (isNaN(mm) ? 0 : mm / 60);
    }

    function csvEscape(value) {
      const str = String(value ?? "");
      return '"' + str.replace(/"/g, '""') + '"';
    }

    // ====== AUDIO ======
    function speak(text) {
      if (!settings.audioEnabled) return;
      if (!window.speechSynthesis) return;
      const utter = new SpeechSynthesisUtterance(text);
      utter.rate = 1;
      utter.pitch = 1;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    }

    // ====== DOM REFS ======
    const currentBankrollInput = document.getElementById("currentBankroll");
    const sessionBankrollInput = document.getElementById("sessionBankroll");
    const dailyPLSpan = document.getElementById("dailyPL");
    const totalPLSpan = document.getElementById("totalPL");
    const winRateSpan = document.getElementById("winRate");
    const betsTodaySpan = document.getElementById("betsToday");
    const heatLevelSpan = document.getElementById("heatLevel");
    const sessionIdSpan = document.getElementById("sessionId");
    const sessionPLSpan = document.getElementById("sessionPL");
    const sessionBetsSpan = document.getElementById("sessionBets");

    const startSessionBtn = document.getElementById("startSessionBtn");
    const saveBankrollBtn = document.getElementById("saveBankrollBtn");

    const betForm = document.getElementById("betForm");
    const formTitle = document.getElementById("formTitle");
    const submitBetBtn = document.getElementById("submitBetBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");

    const betsTableBody = document.querySelector("#betsTable tbody");
    const playbook3List = document.getElementById("playbook3List");
    const combosList = document.getElementById("combosList");
    const trapList = document.getElementById("trapList");
    const noTrapsMsg = document.getElementById("noTrapsMsg");
    const audioToggle = document.getElementById("audioToggle");
    const speakRecapBtn = document.getElementById("speakRecapBtn");
    const logFilterSelect = document.getElementById("logFilterSelect");
    const exportBetsBtn = document.getElementById("exportBetsBtn");
    const resetBetsBtn = document.getElementById("resetBetsBtn");

    // 10 flip refs
    const flipStartBankrollInput = document.getElementById("flipStartBankroll");
    const flipMultiplierInput = document.getElementById("flipMultiplier");
    const flipTotalInput = document.getElementById("flipTotal");
    const flipMetaDiv = document.getElementById("flipMeta");
    const flipResultInput = document.getElementById("flipResultInput");
    const flipTableBody = document.querySelector("#flipTable tbody");
    const initFlipBtn = document.getElementById("initFlipBtn");
    const saveFlipResultBtn = document.getElementById("saveFlipResultBtn");
    const exportFlipBtn = document.getElementById("exportFlipBtn");
    const resetFlipBtn = document.getElementById("resetFlipBtn");

    // ====== NAV (VIEWS) ======
    const navTabs = document.querySelectorAll(".nav-tab");
    const views = document.querySelectorAll(".view");

    function showView(name) {
      views.forEach(v => {
        if (v.getAttribute("data-view") === name) v.classList.add("active");
        else v.classList.remove("active");
      });
      navTabs.forEach(t => {
        if (t.getAttribute("data-target") === name) t.classList.add("active");
        else t.classList.remove("active");
      });
    }

    navTabs.forEach(tab => {
      tab.addEventListener("click", () => {
        const target = tab.getAttribute("data-target");
        showView(target);
      });
    });

    // ====== BETS TABLE ======
    function getFilteredBetsForTable() {
      const filter = logFilterSelect ? logFilterSelect.value : "all";
      const today = todayString();

      return [...bets].filter(b => {
        if (filter === "today") {
          return b.date === today;
        }
        if (filter === "pending") {
          return b.status === "Active" && b.result === "Pending";
        }
        return true; // all
      });
    }

    function renderBetsTable() {
      betsTableBody.innerHTML = "";
      const filtered = getFilteredBetsForTable();
      const sorted = filtered.sort((a, b) => a.id - b.id);

      for (const bet of sorted) {
        const tr = document.createElement("tr");
        const statusClass = bet.status === "Active" ? "status-active" : "status-void";
        const resultClass =
          bet.result === "Win"
            ? "result-win"
            : bet.result === "Loss"
            ? "result-loss"
            : bet.result === "Push"
            ? "result-push"
            : "result-pending";

        tr.innerHTML = `
          <td>${bet.id}</td>
          <td>${bet.date}</td>
          <td>${bet.time}</td>
          <td>${bet.sport || ""}</td>
          <td>${bet.market || ""}</td>
          <td>${bet.description || ""}</td>
          <td>${bet.odds}</td>
          <td>${bet.stake}</td>
          <td class="${resultClass}">${bet.result}</td>
          <td>${bet.riskTag || ""}</td>
          <td>${bet.net.toFixed(2)}</td>
          <td>
            <span class="status-pill ${statusClass}">
              ${bet.status}
            </span>
          </td>
          <td>
            <button class="btn btn-secondary btn-sm edit" data-id="${bet.id}">Edit</button>
            <button class="btn btn-secondary btn-sm void" data-id="${bet.id}">
              ${bet.status === "Active" ? "Void" : "Unvoid"}
            </button>
          </td>
        `;
        betsTableBody.appendChild(tr);
      }

      betsTableBody.querySelectorAll(".edit").forEach(btn => {
        btn.addEventListener("click", () => startEditBet(Number(btn.dataset.id)));
      });
      betsTableBody.querySelectorAll(".void").forEach(btn => {
        btn.addEventListener("click", () => toggleVoidBet(Number(btn.dataset.id)));
      });
    }

    // ====== PLAYBOOK & COMBOS ======
    function riskWeight(riskTag) {
      if (riskTag === "Safe") return 1.5;
      if (riskTag === "Standard") return 1.0;
      if (riskTag === "Aggressive") return 0.5;
      return 1.0;
    }

    function buildCandidateBets() {
      const today = todayString();
      return bets.filter(
        b =>
          b.status === "Active" &&
          b.result === "Pending" &&
          b.date === today
      );
    }

    function renderPlaybookAndCombos() {
      const candidates = buildCandidateBets();

      // 3-Bet
      playbook3List.innerHTML = "";
      if (candidates.length === 0) {
        const li = document.createElement("li");
        li.textContent = "No pending bets for today. Log plays to build the playbook.";
        playbook3List.appendChild(li);
      } else {
        const scored = candidates.map(b => {
          const score = (b.confidence || 3) * riskWeight(b.riskTag);
          return { bet: b, score };
        });
        scored.sort((a, b) => b.score - a.score);
        const top3 = scored.slice(0, 3);

        for (const { bet, score } of top3) {
          const li = document.createElement("li");
          li.textContent = `#${bet.id} ‚Äì ${bet.sport || ""} ${bet.market || ""} ‚Äì ${
            bet.description || ""
          } | Odds ${bet.odds} | Stake ${bet.stake} | Risk ${bet.riskTag} | Conf ${
            bet.confidence
          } | Score ${score.toFixed(2)}`;
          playbook3List.appendChild(li);
        }
      }

      // 2-leg combos
      combosList.innerHTML = "";
      if (candidates.length < 2) {
        const li = document.createElement("li");
        li.textContent = "Need at least 2 pending bets today to build combos.";
        combosList.appendChild(li);
        return;
      }

      const combos = [];
      for (let i = 0; i < candidates.length; i++) {
        for (let j = i + 1; j < candidates.length; j++) {
          const a = candidates[i];
          const b = candidates[j];
          const scoreA = (a.confidence || 3) * riskWeight(a.riskTag);
          const scoreB = (b.confidence || 3) * riskWeight(b.riskTag);
          let comboScore = scoreA + scoreB;
          if (a.riskTag === "Aggressive" && b.riskTag === "Aggressive") comboScore -= 1;
          combos.push({ a, b, comboScore });
        }
      }

      combos.sort((x, y) => y.comboScore - x.comboScore);
      const topCombos = combos.slice(0, 3);
      for (const { a, b, comboScore } of topCombos) {
        const li = document.createElement("li");
        li.textContent = `[#${a.id} + #${b.id}] ‚Äì ${a.description || ""} + ${
          b.description || ""
        } | Risk: ${a.riskTag}/${b.riskTag} | Conf: ${a.confidence}/${b.confidence} | Score ${comboScore.toFixed(
          2
        )}`;
        combosList.appendChild(li);
      }
    }

    // ====== TRAPS ======
    function computeTraps() {
      const traps = [];
      const today = todayString();
      const activeToday = bets
        .filter(b => b.status === "Active" && b.date === today)
        .sort((a, b) => a.id - b.id);

      const betsToday = activeToday.length;

      if (betsToday >= 8) {
        traps.push({
          key: "high_volume",
          message: "High volume today: 8+ bets logged. This is a danger zone for overtrading."
        });
      }

      if (activeToday.length >= 3) {
        const last3 = activeToday.slice(-3);
        if (last3.every(b => b.result === "Loss")) {
          traps.push({
            key: "three_losses",
            message: "Last 3 bets today were losses. Chasing risk is high."
          });
        }
      }

      const aggressiveCount = activeToday.filter(b => b.riskTag === "Aggressive").length;
      if (aggressiveCount >= 3) {
        traps.push({
          key: "aggressive_cluster",
          message: "You have 3+ aggressive bets today. Check if you‚Äôre forcing action."
        });
      }

      const lateBets = activeToday.filter(b => {
        const hour = parseHourFromTimeString(b.time);
        return hour !== null && hour >= 21.5;
      });
      if (lateBets.length >= 4) {
        traps.push({
          key: "late_night",
          message: "Heavy volume after 9:30 PM. Historically discipline collapses here."
        });
      }

      return traps;
    }

    function renderTraps() {
      const traps = computeTraps();
      trapList.innerHTML = "";

      if (traps.length === 0) {
        noTrapsMsg.textContent =
          "No active traps detected. Stay disciplined and follow the framework.";
      } else {
        noTrapsMsg.textContent = "";
      }

      const trapKeys = traps.map(t => t.key);
      const newTraps = traps.filter(t => !lastTrapKeys.includes(t.key));

      for (const t of traps) {
        const li = document.createElement("li");
        li.textContent = t.message;
        trapList.appendChild(li);
      }

      if (newTraps.length > 0) {
        const spoken = newTraps.map(t => t.message).join(" ");
        speak("Trap alert. " + spoken);
      }

      lastTrapKeys = trapKeys;
    }

    // ====== DASHBOARD ======
    function renderDashboard() {
      currentBankrollInput.value =
        settings.bankroll !== undefined ? settings.bankroll : "";
      sessionBankrollInput.value =
        settings.sessionBankroll !== undefined ? settings.sessionBankroll : "";
      sessionIdSpan.textContent = settings.sessionId || "‚Äî";
      audioToggle.checked = !!settings.audioEnabled;

      const today = todayString();
      let dailyNet = 0;
      let totalNet = 0;
      let wins = 0;
      let losses = 0;
      let totalBetsCount = 0;
      let betsTodayCount = 0;

      const activeBets = bets.filter(b => b.status === "Active");

      for (const b of activeBets) {
        totalNet += b.net;
        if (b.result === "Win") wins++;
        if (b.result === "Loss") losses++;
        if (b.result === "Win" || b.result === "Loss") totalBetsCount++;

        if (b.date === today) {
          dailyNet += b.net;
          betsTodayCount++;
        }
      }

      dailyPLSpan.textContent = dailyNet.toFixed(2);
      totalPLSpan.textContent = totalNet.toFixed(2);
      betsTodaySpan.textContent = betsTodayCount;

      const winRate =
        totalBetsCount === 0 ? 0 : (wins / (wins + losses || 1)) * 100;
      winRateSpan.textContent = `${winRate.toFixed(1)}%`;

      // Session stats
      let sessionNet = 0;
      let sessionBetsCount = 0;
      if (settings.sessionId) {
        const sessionBetsArr = activeBets.filter(
          b => b.sessionId === settings.sessionId
        );
        for (const b of sessionBetsArr) {
          sessionNet += b.net;
          if (b.result === "Win" || b.result === "Loss" || b.result === "Push") {
            sessionBetsCount++;
          }
        }
      }
      sessionPLSpan.textContent = sessionNet.toFixed(2);
      sessionBetsSpan.textContent = sessionBetsCount;

      const recentActive = activeBets
        .filter(b => b.date === today)
        .sort((a, b) => b.id - a.id)
        .slice(0, 5);

      const recentLosses = recentActive.filter(b => b.result === "Loss").length;
      const heatBase = betsTodayCount;
      let heatScore = Math.min(10, heatBase + recentLosses * 2);

      heatLevelSpan.textContent = heatScore.toString();
      heatLevelSpan.classList.remove("heat-low", "heat-medium", "heat-high");
      if (heatScore <= 3) heatLevelSpan.classList.add("heat-low");
      else if (heatScore <= 7) heatLevelSpan.classList.add("heat-medium");
      else heatLevelSpan.classList.add("heat-high");

      if (heatScore >= 8 && lastHeatLevel < 8) {
        speak("Heat is high. Consider slowing down or shutting it down.");
      }
      lastHeatLevel = heatScore;

      renderPlaybookAndCombos();
      renderTraps();
    }

    // ====== BETS CRUD ======
    function getFormData() {
      return {
        date: document.getElementById("betDate").value || todayString(),
        time:
          document.getElementById("betTime").value ||
          new Date().toTimeString().slice(0, 5),
        sport: document.getElementById("betSport").value.trim(),
        market: document.getElementById("betMarket").value.trim(),
        description: document.getElementById("betDescription").value.trim(),
        odds: Number(document.getElementById("betOdds").value),
        stake: Number(document.getElementById("betStake").value),
        result: document.getElementById("betResult").value,
        riskTag: document.getElementById("betRiskTag").value,
        confidence: Number(document.getElementById("betConfidence").value),
        emotion: document.getElementById("betEmotion").value.trim()
      };
    }

    function setFormData(bet) {
      document.getElementById("betDate").value = bet.date;
      document.getElementById("betTime").value = bet.time;
      document.getElementById("betSport").value = bet.sport;
      document.getElementById("betMarket").value = bet.market;
      document.getElementById("betDescription").value = bet.description;
      document.getElementById("betOdds").value = bet.odds;
      document.getElementById("betStake").value = bet.stake;
      document.getElementById("betResult").value = bet.result;
      document.getElementById("betRiskTag").value = bet.riskTag;
      document.getElementById("betConfidence").value = bet.confidence;
      document.getElementById("betEmotion").value = bet.emotion || "";
    }

    function clearForm() {
      betForm.reset();
      document.getElementById("betDate").value = todayString();
    }

    function startEditBet(id) {
      const bet = bets.find(b => b.id === id);
      if (!bet) return;
      editingBetId = id;
      formTitle.textContent = `Edit Bet #${id}`;
      submitBetBtn.textContent = "Update Bet";
      cancelEditBtn.style.display = "inline-block";
      setFormData(bet);
    }

    function cancelEdit() {
      editingBetId = null;
      formTitle.textContent = "Log Bet";
      submitBetBtn.textContent = "Save Bet";
      cancelEditBtn.style.display = "none";
      clearForm();
    }

    function toggleVoidBet(id) {
      const bet = bets.find(b => b.id === id);
      if (!bet) return;
      bet.status = bet.status === "Active" ? "Void" : "Active";
      bet.net = calculateNet(bet.result, bet.stake, bet.odds, bet.status);
      saveState();
      renderBetsTable();
      renderDashboard();
    }

    // ====== SESSION ======
    function startNewSession() {
      const now = new Date();
      const stamp = now.toISOString().replace(/[-:]/g, "").slice(0, 15);
      const newId = `S_${stamp}`;
      settings.sessionId = newId;
      settings.sessionBankroll = Number(currentBankrollInput.value) || 0;
      saveState();
      renderDashboard();
    }

    // ====== EXPORT / RESET BETS ======
    function exportBetsCSV() {
      if (!bets.length) {
        alert("No bets to export yet.");
        return;
      }

      const headers = [
        "id",
        "date",
        "time",
        "sport",
        "market",
        "description",
        "odds",
        "stake",
        "result",
        "riskTag",
        "confidence",
        "emotion",
        "net",
        "status",
        "sessionId",
        "createdAt"
      ];

      const rows = bets.map(b => [
        b.id,
        b.date,
        b.time,
        b.sport,
        b.market,
        b.description,
        b.odds,
        b.stake,
        b.result,
        b.riskTag,
        b.confidence,
        b.emotion,
        b.net,
        b.status,
        b.sessionId,
        b.createdAt
      ]);

      const csv =
        headers.map(csvEscape).join(",") +
        "\n" +
        rows.map(r => r.map(csvEscape).join(",")).join("\n");

      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "at_bets_export.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    function resetBets() {
      if (!confirm("This will delete all bets from this browser. Continue?")) return;
      bets = [];
      saveState();
      renderBetsTable();
      renderDashboard();
    }

    // ====== 10 FLIP MODULE ======
    function currentFlipStart() {
      if (flipState.currentFlip === 1) return flipState.startingBankroll;
      const prev = flipState.history.find(h => h.flip === flipState.currentFlip - 1);
      return prev ? prev.result : flipState.startingBankroll;
    }

    function currentFlipTarget() {
      const start = currentFlipStart();
      return start * flipState.multiplier;
    }

    function initFlipChallenge() {
      const start = Number(flipStartBankrollInput.value) || 0;
      const mult = Number(flipMultiplierInput.value) || 2;
      const total = Math.max(1, Number(flipTotalInput.value) || 10);

      flipState.startingBankroll = start;
      flipState.multiplier = mult;
      flipState.totalFlips = total;
      flipState.currentFlip = 1;
      flipState.history = [];
      saveState();
      renderFlipModule();
    }

    function renderFlipModule() {
      flipStartBankrollInput.value = flipState.startingBankroll || "";
      flipMultiplierInput.value = flipState.multiplier || 2;
      flipTotalInput.value = flipState.totalFlips || 10;

      const cf = flipState.currentFlip;
      if (cf > flipState.totalFlips) {
        flipMetaDiv.innerHTML = `<span>Challenge complete. You finished all ${
          flipState.totalFlips
        } flips.</span>`;
      } else {
        const start = currentFlipStart();
        const target = currentFlipTarget();
        flipMetaDiv.innerHTML = `
          <span>Flip: <strong>${cf} / ${flipState.totalFlips}</strong></span>
          <span>Starting Bankroll this Flip: <strong>${start.toFixed(2)}</strong></span>
          <span>Target for this Flip (x${flipState.multiplier}): <strong>${target.toFixed(
          2
        )}</strong></span>
        `;
      }

      flipTableBody.innerHTML = "";
      const rows = flipState.history || [];
      for (const h of rows) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${h.flip}</td>
          <td>${h.start.toFixed(2)}</td>
          <td>${h.target.toFixed(2)}</td>
          <td>${h.result.toFixed(2)}</td>
          <td>${h.status}</td>
        `;
        flipTableBody.appendChild(tr);
      }
    }

    function saveFlipOutcome() {
      if (flipState.currentFlip > flipState.totalFlips) {
        alert("Challenge already complete.");
        return;
      }

      const resultVal = Number(flipResultInput.value);
      if (!resultVal && resultVal !== 0) {
        alert("Enter the bankroll result after this flip.");
        return;
      }

      const flipNum = flipState.currentFlip;
      const start = currentFlipStart();
      const target = currentFlipTarget();
      const status = resultVal >= target ? "Win" : "Loss";

      flipState.history.push({
        flip: flipNum,
        start,
        target,
        result: resultVal,
        status
      });

      flipState.currentFlip = flipNum + 1;
      flipResultInput.value = "";
      saveState();
      renderFlipModule();
    }

    function exportFlipCSV() {
      if (!flipState.history.length) {
        alert("No flip history to export yet.");
        return;
      }

      const headers = ["flip", "start", "target", "result", "status"];
      const rows = flipState.history.map(h => [
        h.flip,
        h.start,
        h.target,
        h.result,
        h.status
      ]);

      const csv =
        headers.map(csvEscape).join(",") +
        "\n" +
        rows.map(r => r.map(csvEscape).join(",")).join("\n");

      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "at_flip_history.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    function resetFlipHistory() {
      if (!confirm("This will clear only flip history (not your base config). Continue?")) return;
      flipState.history = [];
      flipState.currentFlip = 1;
      saveState();
      renderFlipModule();
    }

    // ====== EVENTS ======
    betForm.addEventListener("submit", e => {
      e.preventDefault();
      const data = getFormData();
      if (!data.odds || !data.stake) {
        alert("Odds and stake are required.");
        return;
      }

      if (editingBetId !== null) {
        const bet = bets.find(b => b.id === editingBetId);
        if (!bet) return;
        Object.assign(bet, data);
        bet.sessionId = settings.sessionId;
        bet.status = bet.status || "Active";
        bet.net = calculateNet(bet.result, bet.stake, bet.odds, bet.status);
      } else {
        const newBet = {
          id: generateBetId(),
          ...data,
          sessionId: settings.sessionId,
          status: "Active",
          createdAt: new Date().toISOString()
        };
        newBet.net = calculateNet(
          newBet.result,
          newBet.stake,
          newBet.odds,
          newBet.status
        );
        bets.push(newBet);
      }

      saveState();
      renderBetsTable();
      renderDashboard();
      cancelEdit();
    });

    cancelEditBtn.addEventListener("click", cancelEdit);
    startSessionBtn.addEventListener("click", startNewSession);

    saveBankrollBtn.addEventListener("click", () => {
      settings.bankroll = Number(currentBankrollInput.value) || 0;
      settings.sessionBankroll = Number(sessionBankrollInput.value) || 0;
      saveState();
      renderDashboard();
    });

    audioToggle.addEventListener("change", () => {
      settings.audioEnabled = audioToggle.checked;
      saveState();
    });

    speakRecapBtn.addEventListener("click", () => {
      const today = todayString();
      const activeToday = bets.filter(
        b => b.status === "Active" && b.date === today
      );
      const betsToday = activeToday.length;
      const dailyNet = activeToday.reduce((sum, b) => sum + b.net, 0);
      const heat = heatLevelSpan.textContent || "0";

      const traps = computeTraps();
      const trapText =
        traps.length === 0
          ? "No active traps detected."
          : traps.map(t => t.message).join(" ");

      const recap = `Session ${settings.sessionId || "not set"}. 
      Bets today: ${betsToday}. 
      Daily profit or loss: ${dailyNet.toFixed(2)}. 
      Current heat level: ${heat}. 
      ${trapText}`;

      speak(recap);
    });

    if (logFilterSelect) {
      logFilterSelect.addEventListener("change", () => {
        renderBetsTable();
      });
    }

    if (exportBetsBtn) {
      exportBetsBtn.addEventListener("click", exportBetsCSV);
    }

    if (resetBetsBtn) {
      resetBetsBtn.addEventListener("click", resetBets);
    }

    initFlipBtn.addEventListener("click", initFlipChallenge);
    saveFlipResultBtn.addEventListener("click", saveFlipOutcome);
    exportFlipBtn.addEventListener("click", exportFlipCSV);
    resetFlipBtn.addEventListener("click", resetFlipHistory);

    // ====== INIT ======
    function init() {
      loadState();
      document.getElementById("betDate").value = todayString();
      renderBetsTable();
      renderDashboard();
      renderFlipModule();

      // optional PWA
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("sw.js").catch(() => {});
      }
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>

